# 基金交易功能设计文档 V3：交互式交易日志

本文档详细阐述了基金交易功能的设计方案和技术规格，旨在确保逻辑严谨、用户体验流畅，并为未来的功能扩展打下坚实基础。

## 1. 核心概念：以交易记录为中心

为了实现可修改、可追溯的交易历史，我们将整个系统的核心从“持仓快照”转变为“**以交易记录为中心的账本模型**”。

-   **`TradingRecord` 是唯一事实来源**: `UserPosition` 中的 `shares` (份额), `cost` (成本), 和 `realizedProfit` (落袋收益) 将不再是用户直接修改的“原始数据”，而是通过按时间顺序计算所有 `TradingRecord` 后得出的**派生结果**。
-   **“初始持仓”即首笔交易**: 当用户通过详情弹窗录入或修改他们的“初始持仓”时，系统会在后台将其视为一笔特殊的、位于所有交易历史最前端的“**基准买入**”记录。
-   **“顺序重算 (Replay)”机制**: 任何对历史交易记录的**修改**或**删除**操作，都会触发一个后台的“顺序重算”流程。系统会从零开始，按日期顺序重新应用每一笔交易记录，从而计算出最新的、绝对准确的持仓状态。这个过程对用户是无感的，但它从根本上保证了财务数据的严谨性。

---

## 2. UI/UX 进化：从“操作入口”到“状态单元格”

`FundRow` 中的日期单元格将转变为一个能**反映当日交易状态**的信息单元。

-   **默认状态 (无交易)**:
    -   显示净值、涨幅、和两个独立的链接：红色的“**买**”和蓝色的“**卖**”。
    -   背景色为默认白色，或浅灰色（如果是趋势拐点）。

-   **买入交易状态 (已确认或待处理)**:
    -   “买”/“卖”链接合并为一个“**记录**”按钮。
    -   **如果交易已确认**，点击“记录”按钮可打开弹窗进行**编辑/删除**。
    -   **如果交易待处理**，点击“记录”按钮同样可以打开弹窗进行**编辑/取消**。
    -   单元格背景变为**浅红色**。
    -   如果该日同时是趋势拐点，背景色变为**更深一度的浅红色**。

-   **卖出交易状态 (已确认或待处理)**:
    -   链接合并为“**记录**”按钮。
    -   **如果交易已确认**，点击“记录”按钮可打开弹窗进行**编辑/删除**。
    -   **如果交易待处理**，点击“记录”按钮同样可以打开弹窗进行**编辑/取消**。
    -   单元格背景变为**浅蓝色**。
    -   如果该日是趋势拐点，背景色变为**更深一度的浅蓝色**。

-   **“每日一笔”规则**: 此UI设计天然地执行了“每日只允许一笔交易”的规则。一旦某日有了交易（无论是已确认还是待处理），“买/卖”入口即消失。

---

## 3. 数据结构设计 (Data Structure Design)

-   **唯一标识**: 在“一个基金一天一笔交易”的规则下，**“基金代码 + 日期”** 的组合将作为 `TradingRecord` 的唯一标识，无需引入额外的 `id` 字段。
-   `TradingTask` 的 `id` 字段将保留，因为它用于管理可能在同一天提交的多个不同基金的待处理任务。

### `types.ts` (无新增，仅重申)

```typescript
export interface TradingRecord {
  date: string;
  type: 'buy' | 'sell';
  nav: number;
  sharesChange: number;
  amount: number;
  realizedProfitChange?: number;
}
```

---

## 4. 核心业务逻辑 (Core Business Logic)

### A. 修改/删除已完成的 `TradingRecord`

1.  **触发**: 用户在“记录”弹窗中点击“更新交易”或“删除交易”。
2.  **定位与更新**:
    -   根据 `fund.code` 和 `record.date` 定位到 `userPosition.tradingRecords` 数组。
    -   **更新操作**: 替换数组中对应的旧记录。
    -   **删除操作**: 从数组中移除对应的记录。
3.  **启动重算 (`replayTradingHistory`)**:
    -   获取该基金所有**排序后**的 `tradingRecords`。
    -   初始化一个空的持仓对象 (`{ shares: 0, cost: 0, realizedProfit: 0 }`)。
    -   遍历所有交易记录，**逐一**将每笔交易的影响应用到持仓对象上，实时更新份额、成本和落袋收益。
4.  **更新状态**: 用重算后的最终持仓对象来更新 `App.tsx` 中对应基金的 `userPosition`。

### B. 修改/删除待处理的 `TradingTask`

-   **逻辑简化**: 由于 `TradingTask` 尚未影响已确认的持仓，对其操作非常直接。
-   **取消/删除**: 直接从全局 `tradingTasks` 数组中 `filter` 掉对应 `task.id` 的任务即可。
-   **修改**: (如果未来支持) 直接修改 `tradingTasks` 数组中对应任务的 `value` 字段。
-   **无需重算**: 这些操作**不会**触发 `replayTradingHistory` 流程。

### C. 图表标记 (`FundChart.tsx`)

-   **接收数据**: `FundChart` 组件将接收 `tradingRecords` 数组作为新的 prop。
-   **渲染标记**:
    -   在图表内部，遍历 `tradingRecords`。
    -   在对应的日期 (`x` 轴) 和成交净值 (`y` 轴) 位置上，使用 Recharts 的 `<ReferenceDot>` 组件渲染一个点。
    -   根据 `record.type` 决定点的颜色（红色代表买，蓝色代表卖）。
-   **交互提示**: 为这些点定制 `Tooltip`，当鼠标悬停时，显示详细的交易信息（如“买入 500.00 元，成交净值 1.2345”）。

---

## 5. 组件职责变更

-   **`FundRow.tsx`**:
    -   渲染时检查 `fund.userPosition.tradingRecords` 中是否存在对应日期的记录，以决定UI形态。
    -   点击按钮时，向 `App.tsx` 传递是“创建新交易”还是“编辑旧交易”的意图，并附上 `TradingRecord` (如果是编辑)。

-   **`BuyModal.tsx` & `SellModal.tsx`**:
    -   能够接收一个可选的 `editingRecord` prop，并进入“编辑模式”。
    -   表单预填充数据。
    -   提交按钮变为“**更新交易**”，并新增“**删除交易**”按钮。
    -   `onSubmit` 和 `onDelete` 回调需要能处理记录的更新和删除逻辑。

-   **`FundDetailModal.tsx`**:
    -   用户在此处编辑的“份额”、“成本”和“累计收益”，实际上是在修改那条“**基准买入**”的 `TradingRecord`。保存时同样会触发完整的“顺序重算”。

---

## 总结

此方案将应用的核心功能从“当前状态快照”转变为一个“完整的、可追溯的交易账本”。实现的关键在于**引入“顺序重算”机制**来确保数据的准确性，并在UI上提供清晰的状态反馈和便捷的编辑入口，同时在图表上提供直观的交易点标记，极大地提升了应用的专业性和可用性。