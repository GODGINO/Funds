# 基金回测系统设计文档

## 1. 核心理念与目标

本功能旨在为用户提供一个强大、直观的**策略回测系统**。其核心目标是让用户能够在一个**已知的、真实的历史数据集**上，模拟执行一个**预设的投资策略**，并对该策略的表现进行量化评估。

### 1.1. 解决的核心问题

-   **消除情绪**: 验证一个策略在没有人类情绪（贪婪、恐惧）干扰下的纯粹效果。
-   **量化对比**: 科学地比较不同策略（如定投 vs. 趋势跟踪）或同一策略不同参数（如每月定投500 vs. 1000）的优劣。
-   **风险识别**: 不仅关注收益，更要揭示策略在历史上可能遭遇的**最大风险**（最大回撤），帮助用户建立合理的风险预期。

### 1.2. 重要前提

-   **历史不代表未来**: 系统将在显著位置提示用户“**历史回测表现不代表未来实际收益**”，明确回测是辅助决策工具，而非预测未来的水晶球。
-   **规避“未来函数”**: 系统的核心——回测引擎，必须严格按照时间顺序处理数据，**严禁使用未来数据**来做当下的决策判断，确保回测结果的真实性和可复现性。对于 Zigzag 这类指标，将采用“信号滞后确认”原则来模拟真实交易场景。

---

## 2. 系统核心模块设计

回测系统将由三大核心模块组成：**策略定义**、**回测引擎**和**结果分析**。

### 2.1. 模块一：策略定义 (Strategy Definition)

用户在此模块中选择策略并配置相关参数。我们将分阶段实现不同的策略。

#### **第一阶段 (MVP)**

-   **策略名称**: **定期定额投资 (定投)**
-   **简介**: 最经典、用户基础最广泛的策略，作为 MVP 的核心功能。
-   **可配置参数**:
    -   `initialCapital`: 初始资金 (e.g., 100,000 元)。
    -   `investmentAmount`: 每次定投金额 (e.g., 1,000 元)。
    -   `frequency`: 投资频率 (下拉选项: 每周 / 每月)。
    -   `dayOfWeek` / `dayOfMonth`: 投资日 (e.g., 每周三 / 每月15日)。
    -   `startDate` / `endDate`: 回测时间范围 (日期选择器)。

#### **第二阶段 (扩展)**

-   **策略名称**: **趋势跟踪策略 (基于 Zigzag)**
-   **简介**: 顺势而为，在趋势上升时买入，下降时卖出。
-   **可配置参数**:
    -   `initialCapital`, `startDate`, `endDate` (同上)。
    -   `singleInvestmentAmount`: 每次买入的固定金额。
    -   `zigzagThreshold`: 趋势拐点确认阈值 (%) (复用现有参数)。

-   **策略名称**: **趋势 + 估值策略 (Zigzag + NAV 分位点)**
-   **简介**: 结合趋势和估值，旨在提高信号胜率的高级策略。
-   **可配置参数**:
    -   同上。
    -   `buyPercentileThreshold`: 买入信号的净值分位点上限 (e.g., 仅在分位点 < 20% 时，趋势买入信号才有效)。
    -   `sellPercentileThreshold`: 卖出信号的净值分位点下限 (e.g., 仅在分位点 > 80% 时，趋势卖出信号才有效)。

### 2.2. 模块二：回测引擎 (Backtesting Engine)

这是系统的“心脏”，负责在后台执行模拟交易。

-   **输入**: 基金历史数据 (`FundDataPoint[]`)、用户定义的策略及参数。
-   **核心流程 (时间驱动循环)**:
    1.  **初始化**:
        -   设置虚拟账户：`cash = initialCapital`, `shares = 0`, `totalCost = 0`。
        -   创建一个用于记录所有交易的日志数组 `transactions = []`。
    2.  **数据遍历**: 从 `startDate` 到 `endDate`，逐日遍历历史数据。
    3.  **每日检查**: 在每一天，引擎都会：
        -   检查当天是否满足**策略的买入/卖出条件**。
        -   例如，对于定投策略，检查“今天是不是定投日？”。
    4.  **模拟交易**:
        -   若触发**买入**信号：
            -   从 `cash` 中扣除 `investmentAmount`。
            -   根据当日 `unitNAV` 计算可购得的份额 (`sharesToBuy = investmentAmount / nav`)。
            -   `shares += sharesToBuy`。
            -   `totalCost += investmentAmount`。
            -   在 `transactions` 数组中记录一笔买入日志。
        -   若触发**卖出**信号（未来策略）：
            -   计算卖出份额对应的市值。
            -   `cash += proceeds`。
            -   `shares -= sharesToSell`。
            -   计算并记录实现的利润。
            -   在 `transactions` 数组中记录一笔卖出日志。
    5.  **成本模拟**:
        -   为了让回测更贴近真实，引擎将模拟交易成本。
        -   **申购费**: 买入时，实际到账份额将扣除一个固定的申购费率（如 0.15%）。
        -   **赎回费**: 卖出时，到账现金将扣除赎回费（可根据持有时间做简单模拟）。
-   **输出**: 返回一个包含**性能指标**和**交易日志**的结果对象 `BacktestResult`。

### 2.3. 模块三：结果分析与可视化 (Results Analysis & Visualization)

这是回测的“仪表盘”，用于清晰地展示策略表现。

-   **核心性能指标 (Metrics)**:
    -   `strategyTotalReturn`: 策略总收益率。
    -   `benchmarkTotalReturn`: 基准总收益率（**买入并持有**策略）。
    -   `strategyAnnualizedReturn`: 策略年化收益率。
    -   `benchmarkAnnualizedReturn`: 基准年化收益率。
    -   `maxDrawdown`: **最大回撤**。这是最重要的风险指标，表示策略在历史上可能出现的最大亏损幅度。
    -   `tradeCount`: 总交易次数。
    -   `winRate`: 胜率 (盈利交易次数 / 总交易次数)。
    -   `profitFactor`: 盈亏比 (总盈利 / 总亏损)。

-   **核心可视化图表 (Visualization)**:
    -   **权益曲线对比图**:
        -   **Y 轴**: 累计收益率 (%)。
        -   **X 轴**: 日期。
        -   **策略曲线 (蓝色)**: 展示策略账户净值的增长曲线。
        -   **基准曲线 (灰色)**: 展示从回测第一天买入等额资金并持有不动的收益曲线。
        -   **交易点标记**: 在策略曲线上，用**红点**标记买入操作，**蓝点**标记卖出操作。
    -   **交易记录列表**:
        -   一个详细的表格，列出模拟过程中的每一笔交易（日期、类型、价格、份额、费用等）。

---

## 3. UI/UX 方案

回测功能将作为**基金详情弹窗 (`FundDetailModal`)** 的一个新模块集成。

1.  在 `FundDetailModal` 顶部导航栏中，增加一个新的标签页：“**策略回测**”。
2.  该标签页将采用左右分栏布局：
    -   **左侧：设置区 (宽度约 1/3)**
        -   **策略选择**: 下拉菜单，第一阶段仅有“定期定额”。
        -   **参数配置**: 根据所选策略，动态显示对应的参数输入框（如定投金额、频率、日期等）。
        -   **全局设置**: 初始资金、回测时间范围选择器。
        -   **操作按钮**: 一个醒目的“**开始回测**”按钮。
    -   **右侧：结果区 (宽度约 2/3)**
        -   **默认状态**: 显示引导文字，如“请在左侧配置策略并开始回测”。
        -   **回测后**:
            1.  顶部显示**核心性能指标**的摘要卡片。
            2.  中部是**权益曲线对比图**。
            3.  底部是**交易记录列表**。

---

## 4. 技术实现路径

1.  **新增数据类型 (`types.ts`)**:
    -   `BacktestSettings`: 定义回测设置的接口。
    -   `SimulatedTransaction`: 定义单次模拟交易记录的接口。
    -   `BacktestResult`: 定义回测结果对象的接口。

2.  **新增核心服务 (`services/backtestService.ts`)**:
    -   创建一个纯函数 `runBacktest(settings, historicalData)`。
    -   此函数将实现**回测引擎**的全部逻辑，接收设置和数据，返回 `BacktestResult`。它将是无副作用的，便于测试和维护。

3.  **新增组件 (`components/BacktestingTab.tsx`)**:
    -   创建此新组件，负责渲染整个“策略回测”标签页的 UI。
    -   管理回测设置的组件内部状态。
    -   在用户点击“开始回测”时，调用 `runBacktest` 服务。
    -   将返回的 `BacktestResult` 传递给子组件进行展示。

4.  **新增子组件**:
    -   `BacktestResultsChart.tsx`: 专门用于渲染权益曲线对比图。
    -   `BacktestMetrics.tsx`: 展示核心性能指标。
    -   `TransactionLogs.tsx`: 展示交易记录表格。

5.  **集成到主应用**:
    -   在 `FundDetailModal.tsx` 中引入 `BacktestingTab.tsx`，并将其放置在新的标签页中。
    -   确保 `fund.data` (历史数据) 能正确传递给回测标签页。

这个设计方案从 MVP (定投) 入手，结构清晰，易于扩展，可以在保证核心价值快速交付的同时，为未来更复杂的策略（如趋势跟踪）打下坚实的基础。比如说利用多个基金的分位点, 实现高低切