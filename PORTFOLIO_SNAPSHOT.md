# 持仓切片分析功能设计文档

## 1. 核心理念

“持仓切片分析”功能旨在为用户提供一个强大的**投资决策复盘工具**。它的核心是回答一个关键问题：

> **“如果我在过去某个操作日结束后，就‘冻结’当时的全部持仓并持有至今，它的表现会是怎样？”**

通过将历史上的每一个“持仓快照”应用最新的市场价格进行评估，用户可以直观地量化过去每一个操作（买入、卖出、新增或移除基金）的长期影响，从而洞察哪些决策是明智的，哪些是需要改进的。

---

## 2. 功能逻辑与数据处理

### 2.1. “切片”的定义与生成

-   **什么是切片？**
    “持仓切片”并非一个需要被存储的实体数据。它是在分析时**动态计算**出来的、在某个特定历史日期结束时的**完整投资组合状态**的快照。这个快照精确记录了当时您持有的每一支基金的份额、平均成本以及已实现的落袋收益。

-   **切片的触发机制**
    系统会自动扫描所有基金的**初始持仓日期**及后续的每一笔**交易记录 (`TradingRecord`)**。
    -   任何发生过**买入**或**卖出**操作的**唯一日期**，都会成为一个切片的生成点。
    -   **当您添加一只新基金时**，虽然没有立即的买卖交易，但这只基金的初始持仓状态会被包含在下一个因**其他基金交易**而触发的切片中。
    -   **没有交易的日期，则不会生成切片**，这确保了分析的焦点始终在关键决策点上。

### 2.2. 计算流程

该功能的数据处理遵循一个“**动态回溯，统一计价**”的原则。

1.  **收集切片日期**:
    -   系统首先会遍历所有基金的 `userPosition`，收集所有 `tradingRecords` 中的唯一日期。
    -   这些日期集合将成为所有需要计算的切片的时间点。

2.  **动态回溯计算 (Replay)**:
    -   对于每一个识别出的“切片日期”，系统会在后台进行一次“重演”。
    -   它会从零开始，按时间顺序应用该日期及之前的所有交易记录，精确地重建出在**该日操作完成时**的完整投资组合状态（`SnapshotPortfolio`）。此状态包含每支基金的份额、总成本和总落袋收益。

3.  **应用当前市价进行评估**:
    -   系统会获取**今天最新**的基金净值数据（`latestNAV`，优先使用实时估值）。
    -   然后，将这个最新的净值应用到上一步重建出的“历史持仓组合”上，计算出该切片如果持有至今的各项表现指标。

4.  **性能优化**:
    -   整个计算过程将被包裹在一个 React 的 `useMemo` 钩子中。
    -   只有当 `funds` 或 `tradingRecords` 数据发生变化时，才会触发重新计算，确保了应用的性能和流畅度。

---

## 3. UI/UX 设计

### 3.1. 表格位置与布局

-   新的“持仓切片分析”表格将放置在主基金列表的**正下方**。
-   **基准持仓**: 表格的最后一行将以**高亮背景**显示“**基准持仓**”的表现，它代表了您只使用初始持仓、忽略所有后续交易并持有至今的结果，作为所有策略复盘的起点。
-   表格默认按“**切片日期**”进行**降序**排列，确保用户能最先看到最近操作带来的影响。

### 3.2. 表格列定义

根据我们之前的讨论，表格将包含以下核心字段：

| 列标题 | 英文标识 | 计算逻辑/内容说明 | 格式化示例 |
| :--- | :--- | :--- | :--- |
| **切片日期** | `snapshotDate` | 发生交易的日期，即切片的时间戳。 | `2023-08-15` |
| **总成本** | `totalCostBasis` | 该切片形成时，整个投资组合的总持仓成本。 | `85,230.50` |
| **持有总值** | `currentMarketValue` | `切片的历史份额 × 当前最新净值`，计算出的当前总市值。 | `98,450.20` |
| **累计总值** | `cumulativeValue` | `当前持有总值 + 切片时的落袋收益`。 | `100,950.20` |
| **总收益** | `totalProfit` | `累计总值 - 总成本`。反映了该切片持有至今的总回报。 | <span style="color:red;">+15,719.70</span> |
| **收益率** | `profitRate` | `总收益 / 总成本 × 100%`。 | <span style="color:red;">+18.44%</span> |
| **日收益** | `dailyProfit` | `(今日净值 - 昨日净值) × 切片的历史份额`，汇总所有基金。 | <span style="color:green;">-250.75</span> |
| **日收益率** | `dailyProfitRate` | `日收益 / 昨日持有总值 × 100%`。 | <span style="color:green;">-0.25%</span> |

### 3.3. 视觉与交互

-   **数据格式化**: 所有金额将使用千分位分隔符，并保留两位小数。收益率将保留两位小数并显示百分号。
-   **颜色区分**: 所有的收益和收益率字段将遵循应用已有的颜色规范（正为红，负为绿），提供清晰的视觉指引。
-   **动态更新**: 当用户在主应用中进行任何交易操作（买/卖/修改）后，此表格将自动重新计算并更新，实时反映最新操作的影响。

---

## 4. 技术实现方案

1.  **新增数据类型 (`types.ts`)**:
    创建一个新的接口 `PortfolioSnapshot` 来定义切片表格每一行的数据结构。
    ```typescript
    export interface PortfolioSnapshot {
      snapshotDate: string;
      totalCostBasis: number;
      currentMarketValue: number;
      cumulativeValue: number;
      totalProfit: number;
      profitRate: number;
      dailyProfit: number;
      dailyProfitRate: number;
    }
    ```

2.  **创建新组件 (`components/PortfolioSnapshotTable.tsx`)**:
    -   这是一个纯展示组件，负责接收计算好的 `PortfolioSnapshot[]` 数组。
    -   组件内部将根据上述 UI 设计渲染出表格，并负责所有数据的格式化和颜色应用。

3.  **核心计算逻辑 (`App.tsx`)**:
    -   在 `App.tsx` 中创建一个新的 `useMemo` 钩子，命名为 `portfolioSnapshots`。
    -   该钩子的依赖项将是 `processedFunds`。
    -   **钩子内部逻辑**:
        a. 遍历 `processedFunds`，收集所有基金 `tradingRecords` 中的唯一日期，并排序。
        b. 对于每个日期，再次遍历所有基金，重演（Replay）至该日期的所有交易，计算出当日结束时的**持仓组合快照**（包含每支基金的份额、成本、落袋收益）。
        c. 使用 `processedFunds` 中最新的净值数据，对这个历史快照进行计价，计算出表格所需的各项指标。
        d. 返回 `PortfolioSnapshot[]` 数组。

4.  **在 `App.tsx` 中集成**:
    -   在主 `return` 语句中，于主基金列表 `<div>` 的下方渲染 `<PortfolioSnapshotTable />` 组件。
    -   将 `portfolioSnapshots` 计算结果作为 `prop` 传递给该组件。

---

## 5. 未来的潜在扩展

-   **当日操作详情**: 在表格中增加一列，简要说明当天触发切片生成的关键操作（例如，“买入 招商白酒”、“卖出 医疗ETF”）。
-   **与现持仓对比**: 增加一列，将此切片的**现累计总收益**与用户**真实持仓的当前总收益**进行比较，以量化后续操作的“损益”。
-   **切片详情下钻**: 允许用户点击某一行，展开或弹出一个窗口，显示该切片当时具体的基金构成和持仓比例。