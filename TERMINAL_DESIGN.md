
# Terminal 极客终端功能设计文档

## 1. 设计初衷

**Terminal (终端)** 是为高级用户设计的一个高效、文本驱动的交互界面。它旨在将当前的图形化基金管理程序转化为一个可编程的操作环境。

**核心目标：**
1.  **批量操作效率**：通过一条文本指令完成多只基金的买卖操作，替代繁琐的图形界面点击。
2.  **数据洞察 (Time Travel)**：提供“上帝视角”的历史回溯能力，查看过去某一天的市场状态和持仓切片，且严格规避“未来函数”。
3.  **可扩展性**：为未来接入 LLM (大语言模型) Agent 或强化学习 (RL) 自动交易脚本提供标准的文本输入/输出接口。

---

## 2. 交互设计 (UI/UX)

*   **入口**: 在 `FundInputForm` 区域增加黑色 `>_ Term` 按钮。
*   **界面风格**:
    *   **模态框**: 全屏或宽屏黑色背景模态框，模拟真实终端体验。
    *   **字体**: 使用等宽字体 (Monospace, e.g., Consolas, Menlo) 配合亮绿色/白色文本。
    *   **滚动**: 底部输入，日志向上滚动。
*   **操作体验**:
    *   **自动聚焦**: 打开时自动聚焦输入框。
    *   **历史记录**: 支持 `↑` / `↓` 键切换历史输入命令。
    *   **快捷键**: `Esc` 关闭终端，`Enter` 执行命令。

---

## 3. 指令系统详解

### 3.1. `trade` - 交易指令

用于执行单只或批量的买入/卖出操作。

**语法**: `trade <action> <targets> <value> [date]`

| 参数 | 说明 | 示例值 |
| :--- | :--- | :--- |
| **action** | 动作类型 | `buy`, `sell` |
| **targets** | 目标基金 | `001234` (单只), `001234,005678` (多只), `all` (所有持仓), `tag:科技` (按标签) |
| **value** | 数值 | 买入为**金额** (如 `1000`)；卖出为**份额**或**百分比** (如 `500` 或 `50%`) |
| **date** | 日期 (可选) | `YYYY-MM-DD`。不填默认为**今天**。 |

**执行逻辑**:
1.  **非交易日校验**:
    *   **过去日期**: 如果日期在今天之前且没有历史净值数据，直接报错（判定为过去非交易日）。
    *   **周末校验**: 如果日期是周六/周日，直接报错，禁止创建无效的 Pending 任务。
2.  **状态判定**:
    *   **已确认 (Confirmed)**: 如果 `fund.data` 中存在该日期的净值，立即生成带 `nav` 的确认交易记录。
    *   **待处理 (Pending)**: 如果是今天（未收盘）或未来交易日，生成不带 `nav` 的待处理记录。
3.  **百分比卖出**: 自动计算当前持仓份额的百分比进行卖出。

---

### 3.2. `inspect` - 历史回溯指令

用于查看特定日期的投资组合状态和市场数据矩阵。

**语法**: `inspect [date]`

**返回数据结构 (两部分)**:

1.  **持仓切片快照 (Portfolio Snapshot)**:
    *   **数据源**: 复用全局 `portfolioSnapshots` 计算结果。
    *   **逻辑**: 查找 `<=` 目标日期的最近一个切片。
    *   **字段**: 包含总成本、持有市值、总收益、收益率、**操作收益**、**造成盈亏**、**操作效果**等核心财务指标。
    *   **聚合统计**: 在头部展示全局累计的“总操作收益”和“总造成盈亏”。

2.  **基金数据矩阵 (Fund Matrix)**:
    *   **数据源**: 基于 `fund.baseChartData` (包含历史 + 实时)。
    *   **逻辑**: **严格切片 (Strict Slicing)**。仅筛选 `date <= targetDate` 的数据点。
    *   **禁止未来函数**: 计算趋势 (Zigzag) 和分位点 (Percentile) 时，仅使用切片后的历史数据，模拟当时的真实视角。
    *   **展示列**:
        *   `Code`, `Name`
        *   `Trend(T)`: 基于 T 日视角的 Zigzag 趋势 (e.g., `UP 5.2% (3d)`).
        *   `Pctl(T)`: T 日净值在历史区间的分位点。
        *   `NAV(T)` / `Chg(T)`: T 日当天的净值和涨跌幅。
        *   `NAV(T-N)`...: 历史 N 天的数据回溯 (N 由 `recordCount` 决定)。

---

### 3.3. 辅助指令

*   **`ls` / `list`**: 列出当前所有基金的基础信息 (Code, Name, Cost, Shares)。
*   **`help`**: 显示帮助文档。
*   **`clear`**: 清空屏幕日志。

---

## 4. 关键技术实现

### 4.1. 数据一致性
*   `Terminal` 不维护独立状态，所有操作最终都调用 `App.tsx` 传递的 `setFunds`。
*   修改 `funds` 后，React 的 `useEffect` 链会自动触发 `processPendingTasks` 和 `portfolioSnapshots` 的重算，确保终端操作与图形界面数据完全同步。

### 4.2. 实时数据支持
*   在 `inspect` 功能中，使用 `fund.baseChartData` 而非 `fund.data`。
*   **原因**: `baseChartData` 包含了前端实时获取的估值数据 (Real-time estimation)。这使得用户在盘中输入 `inspect` 今天日期时，能看到最新的实时净值和涨跌幅，而非昨天的数据。

### 4.3. 格式化输出
*   为了在 Web 页面上实现整齐的表格输出，使用了 ASCII 表格生成逻辑，并结合 CSS `whitespace-pre` 和等宽字体来保证对齐。
*   表格支持水平滚动 (`overflow-x: auto`)，以适应包含大量历史天数的宽表展示。

---

## 5. 未来规划 (Roadmap)

1.  **LLM Agent 集成**:
    *   允许用户输入自然语言 (e.g., "帮我把亏损超过 5% 的基金都卖一半")，由 LLM 解析为标准的 `trade` 指令并执行。
2.  **高级绘图 (Plotting)**:
    *   支持 `plot <code>` 指令，在终端内渲染字符画 (ASCII Chart) 或弹出一个迷你图表窗口。
3.  **策略回测 (Backtest)**:
    *   支持 `backtest <strategy> <params>` 指令，直接在终端运行回测并输出报告。
