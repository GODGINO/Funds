# 基金趋势可视化与持仓管理工具

一款交互式的 Web 应用，旨在帮助用户跟踪、可视化、比较多支投资基金的历史表现，并管理个人持仓信息。

## 核心功能

- **持仓管理**:
    - **数据录入**: 在基金详情弹窗中，您可以方便地录入和编辑您的持仓份额、平均成本价、累计收益和自定义标签。
    - **收益计算**: 应用会自动根据您的持仓数据和最新的基金净值，计算出您的估算总值、持有成本、持有收益、累计收益、今日预估收益等多项核心指标。
    - **智能成本展示**: 在图表和表单中，当您的“实际成本”（考虑了已实现收益后）与原始“持仓成本”相同时，界面会自动隐藏“实际成本”的相关显示，避免信息冗余，使界面更整洁。
    - **数据导入**: 在添加基金表单旁提供“导入”功能，允许用户粘贴符合特定格式的 JSON 字符串，以批量替换或恢复所有持仓数据。应用会对数据格式进行校验，确保导入的安全性。
    - **数据持久化**: 您的所有持仓信息都会安全地保存在浏览器的本地存储（Local Storage）中，下次访问时将自动加载。
- **标签系统与筛选**: 为您的每项持仓添加自定义标签（支持Emoji），并在应用顶部生成标签云。点击任意标签即可快速筛选出所有包含该标签的基金，方便您按投资主题或策略进行分组查看。
- **多基金跟踪**: 通过基金的6位代码，同时添加和监控多支基金。
- **历史数据可视化**: 
    - 每支基金的历史单位净值（NAV）都以直观的蓝色折线图形式直接在主表格中展示。
    - **交互式图表提示**: 鼠标悬停在任意基金的走势图上时，会显示一个详细的提示框，内容包括当日日期（及距今天数）、日涨跌幅，以及（如果已录入持仓）根据您的份额计算出的当日预估收益。
- **Zigzag 趋势线**: 在图表上叠加一条“骨架”折线，用于识别主要市场趋势，忽略微小波动。可以通过“趋势阈值”输入框自定义其灵敏度。
- **趋势拐点标记线**: 在图表上，会用一条灰色的垂直虚线明确标记出最近一个趋势拐点的具体位置，让“近期趋势”的起点一目了然。
- **近期趋势分析**: 在基金名称下方，会自动显示自上一个重要趋势拐点以来的天数、以及对应的涨跌幅，格式为“近X天, 上涨/下跌Y%”，帮助您快速判断近期走势。
- **净值分位点**: 自动计算最新净值在选定历史周期内的百分比位置，并以“分位点”的形式展示。
- **集成的控制面板**: 在表格上方，提供了一个集中的控制区域，允许用户自由选择排序标准、排序方式、查看的历史记录数量以及调整趋势线的灵敏度。
- **实时估值**: 查看每支基金最新的实时估值和日涨跌幅估算，并可通过刷新按钮快速更新。
- **详情弹窗视图**: 双击任意基金，即可打开一个功能强大的详细信息弹窗，不仅包含更清晰的性能图表，还是您管理个人持仓的核心界面。
- **基金管理**: 在详情弹窗中可以方便地移除不再需要跟踪的基金，并有二次确认步骤防止误删。
- **响应式设计**: 界面针对桌面和移动设备进行了优化。

## 如何使用

1.  **添加基金**: 在页面底部的“基金代码”输入框中输入一个有效的6位基金代码，然后点击“添加基金”按钮。
2.  **录入持仓**: 双击您刚添加的基金行，打开详情弹窗。在弹窗底部的表单中，输入您的**份额**、**成本价**等信息，然后点击“保存”。
3.  **分析对比**: 返回主列表，您可以看到所有基金的表现对比。使用表格上方的控制面板，选择按“近期趋势”、“今日涨幅”或“分位点”进行排序。
4.  **按标签筛选**: 点击主列表上方的任一标签，即可只查看该分类下的基金。
5.  **刷新估值**: 点击控制面板最右侧的刷新图标按钮，可以快速获取所有已跟踪基金的最新实时估值和您的持仓收益。

## 技术栈

- **前端框架**: React
- **开发语言**: TypeScript
- **样式**: Tailwind CSS
- **图表库**: Recharts
- **数据获取**: 通过 JSONP 直接请求公开的基金数据 API。

---

## 技术实现细节

### 数据结构 (Data Structures)

应用的核心数据围绕以下几个接口进行组织 (`types.ts`):

-   **`UserPosition`**: 新增的接口，用于存储用户的个人持仓数据。
    ```typescript
    interface UserPosition {
      code: string;           // 基金代码 (主键)
      shares: number;         // 持仓份额
      cost: number;           // 平均持仓成本价
      tag?: string;           // 用户自定义标签
      realizedProfit: number; // 已实现的落袋收益
    }
    ```
-   **`Fund`**: 整合了基金的所有信息，现在也包含了用户的持仓数据。
    ```typescript
    interface Fund {
      code: string;
      name: string;
      data: FundDataPoint[];
      realTimeData?: RealTimeData;
      // ... 其他字段
      userPosition?: UserPosition; // 关联的用户持仓信息
    }
    ```

### 核心方法 (Core Methods)

#### 数据获取 (`services/fundService.ts`)

由于基金数据 API 存在跨域请求（CORS）限制，本项目采用了 **JSONP** 技术来绕过这些限制。

-   **请求序列化**: 为了避免并行请求 JSONP 接口时全局回调函数被覆盖而导致的数据错乱问题，应用为两类请求分别维护了一个全局的 Promise 链，确保了同一时间只有一个 JSONP 请求在执行。

#### 图表工具 (`services/chartUtils.ts`)

-   **`calculateZigzag`**: 核心算法，用于计算图表上的趋势线，识别出价格反转超过阈值的重要波峰和波谷。

#### 状态管理与数据持久化 (`App.tsx`)

-   **组件状态**: 应用的核心状态由 `App` 组件中的 `useState` Hooks 管理。
-   **数据处理与排序**: 使用 `useMemo` Hook 来派生出一个经过处理和排序的基金列表。它会为每支基金计算其近期趋势、净值分位点，以及（如果存在持仓）详细的收益指标，然后根据用户选择的排序标准进行排序。
-   **数据持久化**:
    -   应用现在使用 `localStorage` 中的 `userFundPortfolio` 项来持久化数据。
    -   当应用加载时，它会读取这个项目，恢复所有已订阅的基金及其对应的持仓信息。
    -   当基金列表或任何持仓信息发生变化时，`useEffect` Hook会自动将最新的数据写回 `localStorage`，实现无缝保存。

---
## 待办事项 (TODO)

- **交易记录功能**: 实现一个完整的交易记录系统，允许用户添加、编辑和删除单笔买入/卖出交易。系统将根据交易历史自动计算并更新持仓份额、平均成本和已实现收益，而不是手动编辑。

*此 README 文件将随着应用功能的增加而持续更新。*
