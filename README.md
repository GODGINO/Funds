
# 基金趋势可视化与持仓管理工具

一款交互式的 Web 应用，旨在帮助用户跟踪、可视化、比较多支投资基金的历史表现，并管理个人持仓信息。

## 核心功能

- **持仓管理**:
    - **数据录入**: 在基金详情弹窗中，您可以方便地录入和编辑您的持仓份额、平均成本价、累计收益和自定义标签。
    - **收益计算**: 应用会自动根据您的持仓数据和最新的基金净值，计算出您的估算总值、持有成本、持有收益、累计收益、今日预估收益等多项核心指标。
    - **智能成本展示**: 在图表和表单中，当您的“实际成本”（考虑了已实现收益后）与原始“持仓成本”相同时，界面会自动隐藏“实际成本”的相关显示，避免信息冗余，使界面更整洁。
    - **数据导入**: 在添加基金表单旁提供“导入”功能。在弹出的窗口中，您可以粘贴符合特定格式的 JSON 字符串，或者**直接上传一个 JSON 文件**（应用会自动解析文件中的 `subscriptions` 数组），以批量替换或恢复所有持仓数据。应用会对数据格式进行校验，确保导入的安全性。导入过程采用**并行加载**，即使导入大量基金也能快速完成，并能跳过无效数据，确保最大成功率。
    - **数据持久化**: 您的所有持仓信息都会安全地保存在浏览器的本地存储（Local Storage）中，下次访问时将自动加载。
- **隐私模式**:
    - **一键隐藏**: 应用内置了隐私模式，默认开启。
    - **触发条件**: 当鼠标移出浏览器窗口、无任何操作（包括鼠标移动和滚动）超过8秒或单击鼠标右键时，会自动显示一个伪装成 Chrome 断网页面的白色遮罩层，瞬间隐藏所有数据。
    - **信息速览与刷新**: 在遮罩状态下，您的今日预估总盈亏和收益率默认隐藏为`-`，当鼠标移动到遮罩上时才会显示具体数值，移开后再次隐藏。同时，还会显示实时的**上证指数**点位、涨跌额及涨跌幅（指数数据接口经过优化，稳定性更高），让您在隐藏个人信息的同时也能快速掌握大盘动态。单击鼠标左键会触发一次静默的数据刷新，并立即更新遮罩上显示的时间戳和盈亏数据。**全局的每三分钟自动刷新也会在后台照常运行**，并同步更新时间戳，确保遮罩下的数据也能保持最新。
    - **解除方式**: 在遮罩状态下，只需再次单击鼠标右键即可恢复显示。
    - **开关控制**: 在底部的基金添加表单区域，您可以随时通过“隐私模式”开关来启用或禁用此功能。
    - **禁用右键菜单**: 在隐私模式开启期间，浏览器的默认右键菜单会被屏蔽，以确保隐私模式的正常交互。
- **便捷操作**:
    - **一键复制基金代码**: 在主列表中，单击基金代码即可快速将其复制到剪贴板，方便在其他平台查询。复制成功后，代码区域会短暂显示“复制成功”作为反馈。
    - **表单自动清空**: 添加基金成功后，输入表单中的所有字段（基金代码、份额、成本、标签）会自动清空，方便用户连续添加下一支基金。
- **标签系统与筛选**:
    - **智能标签**: 应用会根据您的持仓情况自动生成“持有”（份额 > 0）、“自选”（份额 = 0）、“盈利”（持仓收益 > 0）和“亏损”（持仓收益 < 0）四个系统标签。
    - **自定义标签**: 您仍然可以为每项持仓添加个性化的自定义标签（支持Emoji）。
    - **快速筛选**: 所有标签（包括系统标签和自定义标签）都会显示在顶部的筛选器中，并可通过双击基金列表中的标签来快速筛选，方便您按不同维度进行分组查看。
- **标签分析表格**: 在主列表上方新增一个功能强大的“标签分析”表格，提供对您投资组合的宏观洞察。该表格会自动汇总您所有**自定义标签**下的基金，并进行深度分析：
    -   **核心指标与布局**: 表格的列经过精心布局，将关联指标分组展示，逻辑清晰。
        -   **资产构成**: 清晰展示每个标签分类的**总成本**、**估算总值**和**累计总值**。每个单元格不仅显示绝对金额，还用括号附注了该项占投资组合**总额的百分比**，例如 `18,596 (5%)`，让您对各板块的仓位占比一目了然。
        -   **多维度收益分析**: 对**持有**、**累计**、**今日**和**近期**四个时间维度，都提供了“三位一体”的分析矩阵：
            1.  **收益额**: 绝对的收益金额及其对**总收益的贡献占比**。
            2.  **投资效率**: 独创的效率指标（`收益贡献% / 市值贡献%`）。大于 `1.00x` 的值呈**红色**，代表该板块“跑赢”组合平均水平；小于 `1.00x` 的值呈**绿色**，代表“跑输”。
            3.  **收益率**: 该时间维度下对应的加权收益率。
    -   **对自选基金的智能分析**:
        -   **完整核算**: 对于份额为零的“自选观察”基金，表格会正确计入其**累计收益**（即已实现的落袋收益），确保您的投资历史被完整记录和分析。
        -   **智能收益率**: 当一个标签分类下**没有持仓**时（即所有基金份额均为零），其“今日收益率”和“近期收益率”将自动切换为该分类下所有基金的**简单平均收益率**，而非加权平均，为您提供有意义的参考指标。
    -   **全局总览**: 表头部分集成了**全局总计行**，实时显示您**所有持仓基金**的各项指标总和，作为各项分析的基准。
    -   **基金计数**: 标签名称后会用括号显示该分类下的**基金数量**，如 `☀️新能源 (3)`。
    -   **专业格式化**: 所有数字列均已右对齐，金额字段增加了千分位分隔符，所有盈亏及效率相关的字段都采用了红绿颜色区分，提供了专业、清晰的财务报表阅读体验。
    -   **快速筛选与定位**: 双击表格中的任意标签行，不仅会**立即筛选**主列表以仅显示该标签下的基金，还会**自动平滑滚动**页面至主列表的顶部，方便您立刻查看筛选结果。再次双击则会取消筛选。
    -   **核心目的**: 此表格超越了简单的盈亏展示。通过引入**贡献度占比**和**投资效率**这两个核心概念，它能帮助您深度剖析：哪些投资板块不仅在赚钱，而且是**最高效**地利用您的资金在赚钱，从而为您的调仓决策提供强有力的数据支持。
- **多基金跟踪**: 通过基金的6位代码，同时添加和监控多支基金。
- **历史数据可视化**: 
    - 每支基金的历史单位净值（NAV）都以直观的蓝色折线图形式直接在主表格中展示。
    - **交互式图表提示**: 鼠标悬停在任意基金的走势图上时，会显示一个详细的提示框，内容包括当日日期（及距今天数）、日涨跌幅，以及（如果已录入持仓）根据您的份额计算出的当日预估收益。
- **Zigzag 趋势线**: 在图表上叠加一条“骨架”折线，用于识别主要市场趋势，忽略微小波动。可以通过“趋势阈值”输入框自定义其灵敏度。
- **趋势拐点标记线**: 在图表上，会用一条灰色的垂直虚线明确标记出最近一个趋势拐点的具体位置，让“近期趋势”的起点一目了然。
- **近期趋势分析**: 在基金名称下方，会自动显示自上一个重要趋势拐点以来的天数、对应的涨跌幅，以及根据您的持仓计算出的盈亏金额，格式为“近X天, 上涨/下跌Y%, Z元”，帮助您快速判断近期走势及影响。
- **净值分位点**: 自动计算最新净值在选定历史周期内的百分比位置，并以“分位点”的形式展示。
- **集成的控制面板**: 在表格上方，提供了一个集中的控制区域，允许用户自由选择排序标准、排序方式、查看的历史记录数量以及调整趋势线的灵敏度。现在，这里还会实时显示您所有持仓基金的**今日预估总盈亏**和**加权平均收益率**，让您对整体日度表现一目了然。
- **实时估值与自动刷新**: 应用会在**启动时**、**手动刷新时**以及**每 3 分钟自动刷新**时更新所有基金的实时估值，确保信息最新。所有刷新操作（手动或自动）都会同步更新隐私遮罩上的时间戳。
- **详情弹窗视图**: 双击任意基金，即可打开一个功能强大的详细信息弹窗，不仅包含更清晰的性能图表，还是您管理个人持仓的核心界面。
- **基金管理**: 在详情弹窗中可以方便地移除不再需要跟踪的基金，并有二次确认步骤防止误删。
- **响应式设计**: 界面针对桌面和移动设备进行了优化。

## 如何使用

1.  **添加基金**: 在页面底部的“基金代码”输入框中输入一个有效的6位基金代码，然后点击“添加基金”按钮。
2.  **录入持仓**: 双击您刚添加的基金行，打开详情弹窗。在弹窗底部的表单中，输入您的**份额**、**成本价**等信息，然后点击“保存”。
3.  **分析对比**: 返回主列表，您可以看到所有基金的表现对比。使用表格上方的控制面板，选择按“近期趋势”、“今日涨幅”或“分位点”进行排序。
4.  **按标签筛选**: 点击主列表上方的任一标签，即可只查看该分类下的基金。
5.  **刷新估值**: 点击控制面板最右侧的刷新图标按钮，可以快速获取所有已跟踪基金的最新实时估值和您的持仓收益。

## 技术栈

- **前端框架**: React
- **开发语言**: TypeScript
- **样式**: Tailwind CSS
- **图表库**: Recharts
- **数据获取**: 通过 JSONP 直接请求公开的基金数据 API。

---

## 技术实现细节

### 数据结构 (Data Structures)

应用的核心数据围绕以下几个接口进行组织 (`types.ts`):

-   **`UserPosition`**: 新增的接口，用于存储用户的个人持仓数据。
    ```typescript
    interface UserPosition {
      code: string;           // 基金代码 (主键)
      shares: number;         // 持仓份额
      cost: number;           // 平均持仓成本价
      tag?: string;           // 用户自定义标签
      realizedProfit: number; // 已实现的落袋收益
    }
    ```
-   **`Fund`**: 整合了基金的所有信息，现在也包含了用户的持仓数据。
    ```typescript
    interface Fund {
      code: string;
      name: string;
      data: FundDataPoint[];
      realTimeData?: RealTimeData;
      // ... 其他字段
      userPosition?: UserPosition; // 关联的用户持仓信息
    }
    ```

### 数据流转逻辑 (Data Flow Logic)

应用遵循一个清晰的、由状态驱动的单向数据流。

1.  **数据输入与持久化**:
    *   **来源**: 用户通过 `FundInputForm` (单个添加) 或 `ImportModal` (批量导入) 输入持仓信息。
    *   **状态更新**: 这些操作会调用 `App.tsx` 中的处理函数（如 `handleAddFund`, `handleImportData`），最终更新顶层状态 `funds`。
    *   **持久化**: `App.tsx` 中的一个 `useEffect` 钩子会监听 `funds` 状态的变化。一旦发生变化，它会将所有基金的 `userPosition` 数据提取出来，序列化为 JSON 字符串，并保存到浏览器的 `localStorage` (`userFundPortfolio`键)。应用启动时，会反向执行此过程，从 `localStorage` 加载数据。

2.  **数据获取**:
    *   当 `funds` 状态因添加、导入或从本地存储加载而更新时，`loadFundsFromPositions` 函数会被触发。
    *   它会**并行**发起所有基金的数据获取请求，并调用 `services/fundService.ts` 中的函数来获取每支基金的详细信息和历史净值数据。
    *   **请求序列化**: 为避免 JSONP 的全局回调冲突，所有对外部数据源的请求都被序列化，确保了稳定性和数据准确性。
    *   **鲁棒性与备用数据源**: 为了处理无法提供实时估值的 T+N 类基金，数据获取逻辑采用了“主+备”的策略。
        *   首先，应用会尝试从主要的实时数据接口 (`fundgz`) 获取数据。该接口的响应会被严格校验，即使它返回了基金名称但估值无效（如返回`"--"`），应用也会将其作为无实时数据的基金进行处理。
        *   如果主接口完全失败（例如，返回空数据或网络错误），系统会自动无缝切换到一个备用数据源 (`pingzhongdata`)，尝试获取基金的基本信息（如名称）。此备用请求已优化为使用 HTTPS，以避免混合内容安全问题。
        -   这一机制确保了即便是非实时更新或无历史数据的基金也能被成功添加和跟踪，其估值和历史走势会优雅地显示为空，极大地提高了数据加载的成功率。
    *   **指数数据**: 上证指数数据通过一个更稳定的 `fetch` API 获取，并增加了客户端缓存机制。在网络请求失败时，应用会回退使用缓存数据，确保了指数信息的可用性和展示稳定性。

3.  **核心数据处理与派生**:
    *   **`useMemo` 钩子**: `App.tsx` 中的 `processedAndSortedFunds` 是整个应用数据处理的核心。它是一个 `useMemo` 钩子，依赖于 `funds` 状态和用户的控制选项（如排序方式、筛选标签等）。
    *   **计算过程**: 当依赖项变化时，该钩子会为每一支基金执行以下计算：
        *   合并历史与实时数据，生成用于图表的基础数据。
        *   调用 `calculateZigzag` 计算趋势线拐点。
        *   基于拐点分析**近期趋势** (`trendInfo`)。
        *   计算最新净值的**历史分位点** (`navPercentile`)。
        *   如果存在持仓，则计算所有相关的**投资组合指标**（市值、收益、实际成本等）。

4.  **筛选与排序**:
    *   在完成上述计算后，`processedAndSortedFunds` 会立即根据用户在 `ControlsCard` 中选择的 `activeTag` 进行**筛选**。
    *   接着，根据 `sortBy` 和 `sortOrder` 选项对筛选后的结果进行**排序**。

5.  **渲染**:
    *   经过处理、筛选和排序后的最终基金列表，作为一个 prop 被传递给下面的渲染层。
    *   `FundRow` 组件接收单个基金的所有数据，并将其渲染为表格中的一行，同时将图表所需数据传递给 `FundChart` 组件。

这个流程确保了 UI 始终是顶层 `funds` 状态和用户控制选项的一个确定性函数，使得应用状态可预测且易于管理。

### 组件结构 (`components/`)

- **组件化**: 应用的 UI 被拆分为多个可复用的 React 组件。例如，`ControlsCard.tsx` 统一处理所有的筛选和排序逻辑，而 `FundRow.tsx` 则负责渲染数据表格中的每一行。
- **代码简化**: 在持续迭代中，移除了冗余和未被使用的组件文件（如 `TagFilter.tsx`, `FundDataTable.tsx`），以保持代码库的整洁和可维护性。

---
## 待办事项 (TODO)

- **交易记录功能**: 实现一个完整的交易记录系统，允许用户添加、编辑和删除单笔买入/卖出交易。系统将根据交易历史自动计算并更新持仓份额、平均成本和已实现收益，而不是手动编辑。

*此 README 文件将随着应用功能的增加而持续更新。*