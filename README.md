# 基金趋势可视化工具

一款交互式的 Web 应用，旨在帮助用户跟踪、可视化并比较多支投资基金的历史表现。

## 核心功能

- **多基金跟踪**: 通过基金的6位代码，同时添加和监控多支基金。
- **历史数据可视化**: 每支基金的历史单位净值（NAV）都以直观的蓝色折线图形式直接在主表格中展示。
- **Zigzag 趋势线**: 在图表上叠加一条“骨架”折线，用于识别主要市场趋势，忽略微小波动。可以通过“趋势阈值”输入框自定义其灵敏度。该趋势线以一条低调的灰色实线呈现，以帮助聚焦于主要趋势而非干扰视觉。
- **趋势拐点标记线**: 在图表上，会用一条灰色的垂直虚线明确标记出最近一个趋势拐点的具体位置，让“近期趋势”的起点一目了然。
- **近期趋势分析**: 在基金名称下方，会自动显示自上一个重要趋势拐点以来的天数、以及对应的涨跌幅，格式为“近X天, 上涨/下跌Y%”，帮助您快速判断近期走势。
- **拐点单元格高亮**: 在数据表格中，所有代表趋势拐点的单元格都会以**灰色背景**高亮显示，与图表上的“骨架”趋势线转折点完全对应，方便您快速定位到每一次趋势变化的关键节点。
- **集成的控制面板**: 在表格上方，提供了一个集中的控制区域，允许用户自由选择排序标准（如“近期趋势”或“今日涨幅”）、排序方式（升序或降序）、查看的历史记录数量以及调整趋势线的灵敏度。
- **实时估值**: 查看每支基金最新的实时估值和日涨跌幅估算，并可通过控制面板上的刷新按钮快速更新。
- **详细数据表格**: 并排比较所有已跟踪基金的每日净值和增长率。表格还会计算从任一历史节点到最新净值的百分比变化。
- **详情弹窗视图**: 双击任意基金，即可打开一个包含更大、更清晰性能图表的详细信息弹窗。
- **基金管理**: 在详情弹窗中可以方便地移除不再需要跟踪的基金，并有二次确认步骤防止误删。
- **数据持久化**: 您订阅的基金列表会自动保存在浏览器的本地存储（Local Storage）中，因此您下次访问时选择的基金依然存在。
- **响应式设计**: 界面针对桌面和移动设备进行了优化。

## 如何使用

1.  **调整参数 (可选)**: 在基金列表上方的控制面板中，您可以预先设置希望查看的**历史记录**数量，或调整**趋势阈值**（一个百分比，用于过滤图表上的短期波动，例如 `0.5` 表示只有超过0.5%的波动才被识别为趋势）。
2.  **添加基金**: 在页面底部的“基金代码”输入框中输入一个有效的6位基金代码，然后点击“添加基金”按钮。
3.  **分析对比**: 应用将获取数据并展示在表格中。您可以使用表格上方的控制面板，选择按“近期趋势”或“今日涨幅”进行排序，并随时切换升序或降序。
4.  **刷新估值**: 点击控制面板最右侧的刷新图标按钮，可以快速获取所有已跟踪基金的最新实时估值。
5.  **查看详情/删除**: 双击第一列中的基金名称以打开详细视图。在这里，您也可以将该基金从订阅列表中删除。

## 技术栈

- **前端框架**: React
- **开发语言**: TypeScript
- **样式**: Tailwind CSS
- **图表库**: Recharts
- **数据获取**: 通过 JSONP 直接请求公开的基金数据 API。

---

## 技术实现细节

本应用采用了一些特定的技术方案来确保功能的稳定和高效。

### 数据结构 (Data Structures)

应用的核心数据围绕以下几个接口进行组织 (`types.ts`):

-   **`FundDataPoint`**: 代表单日的基金历史数据。
    ```typescript
    interface FundDataPoint {
      date: string;              // 日期
      unitNAV: number;           // 单位净值
      cumulativeNAV: number;     // 累计净值
      dailyGrowthRate: string;   // 日增长率 (%)
      subscriptionStatus: string;// 申购状态
      redemptionStatus: string;  // 赎回状态
      dividendDistribution: string; // 分红送配
    }
    ```

-   **`RealTimeData`**: 存储基金的实时估值信息。
    ```typescript
    interface RealTimeData {
      estimatedNAV: number;      // 估算净值
      estimatedChange: string;   // 估算涨跌幅 (%)
      estimationTime: string;    // 估值时间
    }
    ```

-   **`Fund`**: 整合了一支基金的所有信息，包括基本信息、历史数据和实时数据。
    ```typescript
    interface Fund {
      code: string;              // 基金代码
      name: string;              // 基金名称
      data: FundDataPoint[];     // 历史数据点数组
      realTimeData?: RealTimeData; // 可选的实时数据
      latestNAV?: number;         // 最新单位净值
      latestChange?: string;      // 最新日涨跌幅
      color?: string;             // 图表颜色
    }
    ```

### 核心方法 (Core Methods)

#### 数据获取 (`services/fundService.ts`)

由于基金数据 API 存在跨域请求（CORS）限制，本项目采用了 **JSONP** (JSON with Padding) 技术来绕过这些限制，直接从前端获取数据。

-   **`fetchFundDetails`**: 通过 `fundgz.1234567.com.cn` 获取基金的名称和实时估值。它动态创建一个 `<script>` 标签来请求数据。
-   **`fetchFundData`**: 通过 `fund.eastmoney.com` 获取基金的历史净值数据。该函数支持分页，可以根据用户选择的记录数量，自动计算需要请求的页数，并合并结果。

-   **请求序列化**: 为了避免并行请求 JSONP 接口时，全局回调函数（如 `window.jsonpgz`）被覆盖而导致的数据错乱问题，应用为两类请求分别维护了一个全局的 Promise 链（`fundDetailsPromise` 和 `fundDataPagePromise`）。这确保了同一时间只有一个 JSONP 请求在执行，后续的请求会排队等待前一个完成后再发出，从而保证了数据获取的可靠性。

#### 图表工具 (`services/chartUtils.ts`)

-   **`calculateZigzag`**: 这是一个核心算法，用于计算图表上的趋势线。它接收基金净值数据和用户设定的百分比阈值（`deviation`）。算法会遍历数据点，识别出价格反转超过阈值的重要波峰和波谷，然后返回这些关键点的集合，用于绘制“骨架”折线图。

#### 状态管理与数据持久化 (`App.tsx`)

-   **组件状态**: 应用的核心状态由 `App` 组件中的 `useState` Hooks 管理，主要包括 `funds` (存储所有基金对象的数组)、`isLoading` (加载状态)、`error` (错误信息) 等。
-   **数据处理与排序**: 应用使用 `useMemo` Hook 来派生出一个经过处理和排序的基金列表。它会为每支基金计算其近期趋势（自上一个拐点以来的涨跌幅），然后根据用户选择的排序标准（如“近期趋势”或“今日涨幅”）对整个列表进行排序。这个经过排序的列表才是最终渲染到页面上的数据源，确保了性能和UI的一致性。
-   **数据持久化**:
    -   当应用首次加载时，`useEffect` Hook会尝试从浏览器的 `localStorage` 中读取一个名为 `subscribedFundCodes` 的项目。如果存在，它会获取这些代码对应的基金数据，并恢复用户的上一次会话。
    -   当 `funds` 数组发生变化（例如用户添加或删除了基金）时，另一个 `useEffect` Hook会被触发，它会将当前所有基金的代码组成的数组，以 JSON 字符串的形式写回 `localStorage`，从而实现数据的自动保存。

---
*此 README 文件将随着应用功能的增加而持续更新。*